# CODEMAP — File Logic & Responsibility Map

> **Forensic Audit**
> Generated by Antigravity on 2026-01-11

## 1. Directory Structure Overview
```
/
├── app/                  # Next.js App Router (UI + API)
│   ├── (auth)/           # Login/Signup/Logout pages
│   ├── api/              # API Routes
│   │   ├── v1/           # Public/Cron API (Key/Secret Auth)
│   │   ├── internal/     # System/Maintenance API
│   │   └── [others]      # UI-facing API (Session Auth)
│   └── dashboard/        # Authenticated UI (Protected)
├── components/           # React Components (UI)
├── lib/                  # Shared Business Logic & DB Access
├── db/                   # Database Migrations (SQL)
├── .github/              # CI/CD & Cron Workflows
└── scripts/              # Verification & Setup Utilities
```

## 2. Detailed File Map

### `app/` (Next.js Routes)

| File / Path | Type | Purpose / Logic | Auth Boundary |
|-------------|------|-----------------|---------------|
| `layout.tsx` | Layout | Root layout, HTML shell, Font config. | Public |
| `page.tsx` | Page | Landing page (Marketing). | Public |
| `globals.css` | Styles | Global Tailwind directives & variables. | Public |

#### `app/dashboard/` (Protected UI)
| File / Path | Type | Purpose / Logic | Auth Boundary |
|-------------|------|-----------------|---------------|
| `page.tsx` | Page | Main Dashboard. Fetches summary data (swr/server-action). | **Session** |
| `layout.tsx` | Layout| Dashboard shell (Sidebar, UserMenu). | **Session** |

#### `app/api/` (Backend Layer)
*Note: Distinct split between `v1/` (Machine/Cron) and Root (UI).*

**Public/Machine API (`v1/`)**
| Path | Method | Purpose | Auth |
|------|--------|---------|------|
| `v1/logs/ingest/route.ts` | POST | Ingests logs from external services. | **API Key** |
| `v1/rules/evaluate/route.ts`| POST | Cron trigger to check alert rules. | **Cron Secret** |
| `v1/notifications/process`| POST | Cron trigger to send pending alerts. | **Cron Secret** |
| `v1/github/webhook` | POST | Receives GitHub deployment events. | **Sig Verify** |

**Internal/System API (`internal/`)**
| Path | Method | Purpose | Auth |
|------|--------|---------|------|
| `internal/logs/cleanup` | POST | Hard delete old logs (Retention). | **Cron Secret** |

**UI-Facing API (Root `api/`)**
| Path | Method | Purpose | Auth |
|------|--------|---------|------|
| `api/auth/login` | POST | Validates methods, sets Session Cookie. | Public |
| `api/auth/signup` | POST | Creates User + Org + Default Service. | Public |
| `api/auth/logout` | POST | Destroys session. | Session |
| `api/alerts/*` | CRUD | Manage Alert Rules (UI). | **Session** |
| `api/services/*` | CRUD | Manage Services/Envs/Keys. | **Session** |
| `api/logs/*` | GET | Query logs for Log Explorer. | **Session** |
| `api/orgs/*` | CRUD | Manage Organization settings. | **Session** |

### `lib/` (Core Logic)

| File | Purpose | Key Exports | Risks |
|------|---------|-------------|-------|
| `lib/db/index.ts` | DB Connection | `sql` (Vercel Postgres SDK). | Connection Limits |
| `lib/auth/session.ts`| Auth Logic | `createSession`, `getSessionFromCookies`. | **Critical**: Auth handling |
| `lib/keys/apiKey.ts` | Crypto | `hashApiKey`, `validateApiKey`. | **Critical**: Key leakage |
| `lib/utils.ts` | Helpers | `cn` (Tailwind), Date formatters. | Low |

### `.github/workflows/` (Automation)

| File | Trigger | Purpose |
|------|---------|---------|
| `ci.yml` | Push | Lint, Typecheck, Test. |
| `cron-rules-evaluate.yml` | Schedule (5m) | Triggers `api/v1/rules/evaluate`. |
| `cron-notifications.yml` | Schedule (1m) | Triggers `api/v1/notifications`. |
| `cron-logs-cleanup.yml` | Schedule (24h) | Triggers `api/internal/logs/cleanup`. |

### `db/` (Database)

| File | Purpose | Notes |
|------|---------|-------|
| `migrations/*.sql` | SQL DDL | Schema history. |
| `schema.prisma` | (Docs) | Reference schema (if present). |

### `scripts/` (DevOps)

| File | Purpose | Usage |
|------|---------|-------|
| `verify-e2e.ts` | Smoke Test | Runs a full signup->ingest->alert loop. |
| `smoke-prod-check.ts` | Prod Verify | Quick curl check against production. |

## 3. Hotspots & Risks
1.  **Auth fragmentation**: Shared secrets for cron vs Cookies for UI vs API Keys for Ingest. Easy to miss a check.
2.  **Cron Reliability**: Relies on GitHub Actions availability and Vercel limits (Duration).
3.  **Ingest Volume**: Direct INSERT to Postgres. Risk of locking/bloat under load.
4.  **Secrets**: `CRON_SECRET` and `INTERNAL_CRON_SECRET` must be set in Vercel.
