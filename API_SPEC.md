# API_SPEC â€” Endpoints & Contracts

> **Forensic Audit**
> Generated by Antigravity on 2026-01-11

## 1. Public / Machine API (`/api/v1`)
These endpoints are designed for high-throughput machine use (agents, webhooks, cron jobs).

### `POST /api/v1/logs/ingest`
**Purpose**: Ingests log entries from external services.
**Auth**: `X-API-Key` (Hashed check against `api_keys`).
**Rate Limit**: Enforced per-minute window via `api_key_rate_buckets`.

**Request Schema (`IngestBodySchema`)**:
```json
{
  "logs": [
    {
      "level": "info" | "warn" | "error" | "debug",
      "message": "string",
      "timestamp": "ISO8601",
      "service_id": "uuid (optional, overrides key default)",
      "meta": { "key": "value" },
      "trace_id": "string (optional)",
      "request_id": "string (optional)"
    }
  ]
}
```

**Response**:
- `200 OK`: `{ "data": { "accepted": 15 } }`
- `401 Unauthorized`: Missing/Invalid Key.
- `429 Too Many Requests`: Rate limit hit.
- `413 Payload Too Large`: > 256KB.

**DB Impact**:
- `INSERT INTO logs` (Batch)
- `UPSERT INTO api_key_rate_buckets` (Atomic count increment)

---

### `POST /api/v1/rules/evaluate`
**Purpose**: Evaluates active alert rules (Error Count, Deployment Failure) against recent logs.
**Auth**: `x-internal-cron-secret` (Must match env `INTERNAL_CRON_SECRET`).
**Cron Schedule**: Every 5 minutes.

**Logic**:
1. Selects enabled `alert_rules`.
2. For each rule:
   - Queries `logs` or `deployments` based on `params_json`.
   - If threshold met -> `INSERT` into `alert_firings`.
   - If new or re-trigger -> `INSERT` into `incidents` or `incident_events`.
   - Queues notifications via `notification_jobs`.

**Response**:
- `200 OK`: Summary of evaluated rules and triggered counts.

---

### `POST /api/v1/notifications/process`
**Purpose**: Processes the async notification queue (Slack/Discord Webhooks).
**Auth**: `x-internal-cron-secret`.
**Cron Schedule**: Every 1 minute.

**Logic**:
1. Selects `pending` jobs from `notification_jobs`.
2. Dispatches HTTP POST to external webhook.
3. Updates job status to `completed` or `failed`.

---

### `POST /api/v1/github/webhook`
**Purpose**: Receives deployment events from GitHub (e.g., Vercel deployment status via GH).
**Auth**: HMAC Signature verification (`X-Hub-Signature-256`).

**Payload**: Standard GitHub DeploymentStatusEvent.
**DB Impact**: `INSERT INTO deployments`.

---

## 2. UI / Internal API (`/api`)
These endpoints support the React frontend. Auth is session-cookie based (`pulseops_session`).

### Auth Routes
- `POST /api/auth/login`: Email/Password check. Sets HTTP-only cookie.
- `POST /api/auth/signup`: Creates User, Org, default Service. Sets cookie.
- `POST /api/auth/logout`: Deletes session from DB and clears cookie.
- `GET /api/me`: Returns current user/org context.

### Resource Routes
- `GET /api/logs`: Query logs with filters (service, env, level, search, date range).
- `GET /api/diagnostics/summary`: High-level stats for dashboard (Open incidents, Failed jobs).

### Org Management
- `POST /api/services`: Create Service.
- `POST /api/services/[id]/keys`: Generate API Key.
- `GET /api/services`: List services + environments.

---

## 3. Error Handling Standard
All API responses follow a consistent error envelope:
```json
{
  "error": {
    "code": "ERROR_CODE_STRING",
    "message": "Human readable message",
    "details": { ...zod_errors }
  },
  "correlationId": "req_..."
}
```
User-facing APIs may redirect to `/login` on 401.
