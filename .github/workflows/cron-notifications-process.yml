name: Cron - Process Notifications

on:
  # schedule:
  #   - cron: '*/5 * * * *' # Every 5 minutes
  workflow_dispatch: # Manual trigger

concurrency:
  group: cron-process-notifications
  cancel-in-progress: true

jobs:
  process-notifications:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Call Processor Endpoint
        env:
          PROD_URL: ${{ secrets.CRON_BASE_URL }}
          INTERNAL_CRON_SECRET: ${{ secrets.INTERNAL_CRON_SECRET }}
          VERCEL_PROTECTION_BYPASS: ${{ secrets.VERCEL_PROTECTION_BYPASS }}
        run: |
          set -euo pipefail

          PROD_URL="${PROD_URL:-https://pulseops-lite.vercel.app}"
          ENDPOINT="/api/v1/notifications/process"

          URL="${PROD_URL}${ENDPOINT}?x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=${VERCEL_PROTECTION_BYPASS}"
          SAFE_URL="${PROD_URL}${ENDPOINT}?x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=REDACTED"

          echo "Request: POST ${SAFE_URL}"

          status=$(curl -sS -D headers.txt -o body.txt -w "%{http_code}" \
            -X POST "$URL" \
            -H "x-internal-cron-secret: ${INTERNAL_CRON_SECRET}" \
          )

          echo "HTTP Status: $status"
          ctype=$(grep -i "^content-type:" headers.txt | head -n 1 || true)
          echo "Content-Type: ${ctype:-unknown}"
          echo "Body (first 300 chars):"
          head -c 300 body.txt || true
          echo

          if [ "$status" -lt 200 ] || [ "$status" -ge 300 ]; then
            echo "Non-2xx response. Failing workflow."
            exit 1
          fi
