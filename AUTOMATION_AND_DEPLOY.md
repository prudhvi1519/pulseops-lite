# AUTOMATION_AND_DEPLOY â€” CI/CD & Operations

> **Forensic Audit**
> Generated by Antigravity on 2026-01-11

## 1. Deployment Maps

### Production Target: Vercel (recommended)
- **Framework**: Next.js App Router.
- **Database**: Vercel Postgres.
- **Env Vars Required**:
  - `POSTGRES_URL`, `POSTGRES_PRISMA_URL`, etc. (DB Connection)
  - `INTERNAL_CRON_SECRET`: Shared secret for cron job auth.
  - `CRON_BASE_URL`: Base URL for cron jobs to call (e.g., `https://pulseops-lite.vercel.app`).
  - `VERCEL_PROTECTION_BYPASS`: (Optional) To bypass Vercel deployment protection if enabled.

### Deployment Flow
1. **Push to Main** -> Vercel Auto-Deploy.
2. **Build**: `next build`.
3. **Migration**: User must run `pnpm db:migrate` manually or add to build command/post-install (Risk: Timeouts).

## 2. CI/CD Workflows (`.github/workflows`)

### `ci.yml` (Code Quality)
- **Trigger**: Push to branches.
- **Steps**:
  - Checkout.
  - Setup Node + pnpm.
  - `pnpm lint`: ESLint check.
  - `pnpm typecheck`: TSC check.
  - `pnpm test`: Vitest unit tests.
- **Status**: **Active**.

### `cron-rules-evaluate.yml` (Core Logic)
- **Trigger**: Schedule `*/5 * * * *` (Every 5 mins).
- **Action**: `curl -X POST $CRON_BASE_URL/api/v1/rules/evaluate`.
- **Headers**: 
  - `x-internal-cron-secret`: Auth.
  - `x-vercel-set-bypass-cookie=true`: Bypass Vercel auth if needed.

### `cron-notifications-process.yml` (Async Queue)
- **Trigger**: Schedule `*/5 * * * *` (Every 5 mins).
- **Action**: `curl -X POST $CRON_BASE_URL/api/v1/notifications/process`.

### `cron-logs-cleanup.yml` (Maintenance)
- **Trigger**: Daily.
- **Action**: Calls `api/internal/logs/cleanup` to delete logs > 7 days (or configured retention).

## 3. Operational Playbook

### Failure Mode: Cron Failures
- **Symptom**: Incidents not creating, Notifications not sending.
- **Debug**: Check GitHub Actions logs. Verify `CRON_BASE_URL` is correct. Verify `INTERNAL_CRON_SECRET` matches Vercel env.

### Failure Mode: Ingest 429
- **Symptom**: External services get Rate Limited.
- **Fix**: Check `api_key_rate_buckets` table. Increase limit in `lib/logs/types.ts` or add retry logic to client.

### Failure Mode: Migration Lock
- **Symptom**: Deploy hangs.
- **Fix**: Kill blocking queries in Postgres. Run migration locally via `pnpm db:migrate` if safe.
