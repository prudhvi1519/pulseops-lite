# SECURITY_REVIEW — Vulnerability & Hardening Audit

> **Forensic Audit**
> Generated by Antigravity on 2026-01-11

## 1. Authentication Model
- **UI Auth**: Custom Session Implementation (`lib/auth/session.ts`).
  - **Storage**: `logs`, `users`, `sessions` tables.
  - **Mechanism**: Random 32-byte token, SHA-256 hashed in DB.
  - **Transport**: `HttpOnly`, `Secure` (prod), `SameSite=Lax` Cookie.
  - **Rating**: **Strong**. Hashing tokens prevents leak-from-database attacks.

- **API Auth (Ingest)**: API Keys (`lib/keys/apiKey.ts`).
  - **Storage**: `api_keys` table (Hashed).
  - **Mechanism**: `x-api-key` header.
  - **Rating**: **Strong**. Hashed storage reduces risk.

- **Cron Auth**: Shared Secret (`x-internal-cron-secret`).
  - **Mechanism**: Env var comparison.
  - **Risk**: Rotated manually. If `INTERNAL_CRON_SECRET` leaks, attacker can trigger evaluation loops (DoS).

## 2. Authorization & Isolation (Multi-Tenancy)
- **Strategy**: Row-Level Logic (Application Side).
- **Enforcement**:
  - `api/v1/logs/ingest`: Helper `verifyApiKey` returns `orgId`. Insert uses this `orgId` explicitly.
  - `api/v1/rules/evaluate`: Queries filtered by `org_id`.
  - `api/me`: Returns data only for `session.userId`.
- **Audit**:
  - Checked `logs/route.ts`: ✅ Uses `keyRecord.orgId`.
  - Checked `rules/evaluate/route.ts`: ✅ `WHERE enabled = true`. Queries logs with `org_id = $1`.
- **Rating**: **PASS**. Codebase diligently applies `org_id` filters.

## 3. Common Vulnerabilities

### A. Injection
- **SQL Injection**: Vercel Postgres (`@vercel/postgres`) `sql` template literal is used.
  - Usage: `sql\`SELECT ... WHERE id = ${id}\``.
  - Status: **Safe**. Parameterized by default.

### B. XSS (Cross-Site Scripting)
- **React**: Auto-escapes content.
- **Risk**: `meta_json` rendering if not carefully handled.
- **Status**: **Low Risk**.

### C. Rate Limiting / DoS
- **Ingest**: Explicit Atomic Rate Limiting (`api_key_rate_buckets`) implemented in `logs/ingest/route.ts`.
- **Auth Routes**: No visible rate limiting on `/api/auth/login`. **Risk**: Brute force.
- **Public**: No global rate limit middleware visible.

## 4. Top 5 Hardening Recommendations
1.  **Add Rate Limiting to Login**: Brute force protection on `/api/auth/login` is missing.
2.  **Secret Rotation Strategy**: Document how to rotate `INTERNAL_CRON_SECRET`.
3.  **Content Security Policy**: Add `CSP` headers via `next.config.js` or middleware.
4.  **Audit Logs**: Enable `0010_audit_logs.sql` integration. Currently `logs` exist but explicit audit trail of *user actions* (changed settings, deleted keys) is vague.
5.  **Payload Validation**: Ensure `meta_json` is size-constrained (Zod schema does this, verified `IngestBodySchema` limit).
