# DB_SCHEMA â€” Tables & Relationships

> **Forensic Audit**
> Generated by Antigravity on 2026-01-11

## 1. Schema Overview
- **Source**: Vercel Postgres (PostgreSQL 15+).
- **Management**: Raw SQL Migrations (`db/migrations/*.sql`) executed by `scripts/migrate.ts`.
- **Tenancy**: Strict multi-tenancy. Almost every table has `org_id` UUID foreign key.
- **IDs**: UUID (v4) for Entities, BigInt/BigSerial for High-Volume Logs.

## 2. Table Definitions

### Identity & Access (`0001_identity.sql`, `0002_services.sql`)

#### `orgs`
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `id` | UUID | PK | `gen_random_uuid()` |
| `name` | TEXT | | |
| `created_at`| TIMESTAMPTZ | | |

#### `users`
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `id` | UUID | PK | |
| `email` | TEXT | UNIQUE| |
| `password_hash`| TEXT | | Bcrypt hash |

#### `org_members` (Join Table)
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `org_id` | UUID | PK(Composite) | Cascade Delete |
| `user_id` | UUID | PK(Composite) | Cascade Delete |
| `role` | TEXT | | 'admin', 'developer', 'viewer' |

#### `sessions`
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `id` | UUID | PK | |
| `user_id` | UUID | IDX | |
| `session_token_hash`| TEXT | UNIQUE | SHA-256 of cookie token |
| `expires_at` | TIMESTAMPTZ | IDX | |

#### `api_keys`
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `id` | UUID | PK | |
| `key_hash` | TEXT | UNIQUE | SHA-256 of raw key |
| `org_id` | UUID | | |
| `service_id` | UUID | | |

---

### Observability Data (`0003_logs.sql`)

#### `logs` (High Volume)
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `id` | BIGSERIAL | PK | |
| `org_id` | UUID | IDX (part) | |
| `service_id` | UUID | | |
| `environment_id`| UUID | | |
| `ts` | TIMESTAMPTZ | IDX (Scope) | Timestamp of event |
| `level` | TEXT | IDX | 'info', 'error', etc. |
| `message` | TEXT | GIN (FTS) | Full Text Search |
| `meta_json` | JSONB | GIN | Arbitrary metadata |

**Indexes**:
1. `logs_scope_ts_idx`: `(org_id, service_id, environment_id, ts DESC)` - Core dashboard query.
2. `logs_org_ts_idx`: `(org_id, ts DESC)` - Org-wide stream.
3. `logs_level_idx`: `(org_id, level, ts DESC)` - Filtering by error.
4. `logs_message_fts_idx`: GIN TSVector - Search.

#### `api_key_rate_buckets`
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `api_key_id` | UUID | PK (Comp) | |
| `window_start`| TIMESTAMPTZ | PK (Comp) | Minute precision |
| `count` | INT | | |

---

### Alerting & State (`0006_incidents.sql`, `0007_alert_rules.sql`)

#### `alert_rules`
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `id` | UUID | PK | |
| `type` | TEXT | | 'error_count', 'deployment_failure' |
| `params_json`| JSONB | | Config (thresholds) |

#### `incidents`
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `id` | UUID | PK | |
| `status` | TEXT | | 'open', 'resolved' |
| `fingerprint`| TEXT | | Auto-dedupe key |

#### `alert_firings` (State)
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `rule_id` | UUID | PK (Comp) | |
| `fingerprint`| TEXT | PK (Comp) | |
| `fired_at` | TIMESTAMPTZ | | Last trigger time |

#### `webhook_deliveries` (`0012_webhook_deliveries.sql`)
| Column | Type | Index | Notes |
|--------|------|-------|-------|
| `id` | UUID | PK | |
| `provider` | TEXT | | 'github' |
| `delivery_id`| TEXT | PK (Comp) | GitHub's guid |
| `event` | TEXT | | 'workflow_run' |
| `payload_hash`| TEXT | | SHA256 of body |
| `created_at` | TIMESTAMPTZ | IDX | |
| **Constraint**: `uq_webhook_delivery_provider_id` | | |

---

## 3. Query Hotspots & Risks
1.  **Logs Insert**: Direct `INSERT` into `logs` table can become a bottleneck. No partitioning strategy visible yet (future risk).
2.  **Rate Limiting**: `ON CONFLICT` update on `api_key_rate_buckets` can cause row lock contention under heavy parallel ingest for the *same* API key.
3.  **Logs Query**: Text search (`message`) uses GIN, which is heavy to maintain on high write volume.
4.  **Cleanup**: `v1/internal/logs/cleanup` deletes entries. Large deletes can cause table bloat if not vacuumed (Postgres specific).

## 4. Tenant Isolation Audit
- **Findings**: Every query in `logs/route.ts` and `rules/evaluate/route.ts` explicitly includes `org_id`.
- **Status**: **PASS**. Schema enforces foreign keys to `orgs`, making accidental cross-tenant data orphaned (and cascade deleted) or constraint-failed.
